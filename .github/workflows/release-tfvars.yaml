name: Create Release tfvars

on:
  push:
    tags:
      - release-*

permissions:
  id-token: write
  contents: write

jobs:
  pre-creation-checks:
    runs-on: ubuntu-latest
    outputs:
      release_build_required: ${{ steps.pre-creation-checks.outputs.release_build_required }}
    steps:
      - uses: actions/checkout@v4
      - name: Pre Creation Checks
        id: pre-creation-checks
        uses: dvsa/des-workflow-actions/.github/actions/create-release-tfvars/pre-creation-checks@MES-9153-gha-release-tfvars
        with:
          component: 'api'
          secrets: ${{ toJSON(secrets) }}

  build-artefact-for-release:
    needs: pre-creation-checks
    if: ${{ jobs.pre-creation-checks.outputs.release_build_required }}
    uses: dvsa/des-workflow-actions/.github/workflows/deploy-backend.yaml@main
    with:
      component: 'api'
    secrets: inherit

  create-release-tfvars:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name:
        uses: dvsa/des-workflow-actions/.github/actions/create-release-tfvars/create-service-release-tfvars@MES-9153-gha-release-tfvars
        with:
          component: 'api'